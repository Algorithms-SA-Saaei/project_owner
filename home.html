<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <link rel="stylesheet" href="./style.css">
</head>
<body>

<div class="container stat-container">
  <img alt="" id="logo" src="./logo.png"/>
  <p id="projectName" class="fw-bold text-center mt-3">--</p>

  <div class="stat-card">
    <div class="stat-value-box">
      <div class="icon-box" title="Ø§ØªØµØ§Ù„ ÙˆØ±Ø³Ø§Ù„Ø©">
        <i class="fas fa-comment-dots"></i>
      </div>
      <span class="stat-value" id="stat-value1">--
        <small class="text-white-50">Ø§ØªØµØ§Ù„ ÙˆØ±Ø³Ø§Ù„Ø©</small>
      </span>
    </div>
    <div class="stat-label">Ø¹Ø¯Ø¯ Ø§Ù„ØªÙˆØ§ØµÙ„</div>
  </div>

  <div class="stat-card">
    <div class="stat-label">Ø¹Ø¯Ø¯ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª</div>
    <div class="stat-value-box">
      <span class="stat-value" id="stat-value2">--
        <small class="text-white-50">Ø¹Ù…ÙŠÙ„</small>
      </span>
      <div class="icon-box" title="Ø¹Ù…ÙŠÙ„">
        <i class="fas fa-users"></i>
      </div>
    </div>
  </div>

  <div class="stat-card">
    <div class="stat-value-box">
      <div class="icon-box" title="Ù…Ø­Ø¬ÙˆØ²">
        <i class="fas fa-building"></i>
      </div>
      <span class="stat-value" id="stat-value3">--
        <small class="text-white-50">Ø­Ø¬Ø²</small>
      </span>
    </div>
    <div class="stat-label">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø­Ø¬ÙˆØ²</div>
  </div>

  <div class="stat-card">
    <div class="stat-label">Ø¹Ø¯Ø¯ Ø§Ù„Ø´Ù‚Ù‚ Ø§Ù„Ù…ÙØ±ØºØ©</div>
    <div class="stat-value-box">
      <span class="stat-value" id="stat-value4">--
        <small class="text-white-50">Ø´Ù‚Ø©</small>
      </span>
      <div class="icon-box" title="Ø´Ù‚Ù‚ Ù…ÙØ±ØºØ©">
        <i class="fas fa-building"></i>
      </div>
    </div>
  </div>

  <div class="stat-card">
    <div class="stat-value-box">
      <div class="icon-box" title="Ø´Ù‚Ù‚ ØºÙŠØ± Ù…ÙØ±ØºØ©">
        <i class="fas fa-building"></i>
      </div>
      <span class="stat-value" id="stat-value5">--
        <small class="text-white-50">Ø´Ù‚Ø©</small>
      </span>
    </div>
    <div class="stat-label">Ø¹Ø¯Ø¯ Ø§Ù„Ø´Ù‚Ù‚ ØºÙŠØ± Ø§Ù„Ù…ÙØ±ØºØ©</div>
  </div>

  <div class="stat-card last-card">
    <div class="stat-value-box">
      <div class="icon-box" title="Ù…Ø´Ø§Ù‡Ø¯Ø§Øª">
        <i class="fas fa-eye"></i>
      </div>
      <span class="stat-value" id="stat-value6">--
        <small class="text-white-50">Ù…Ø´Ø§Ù‡Ø¯Ø©</small>
      </span>
    </div>
    <div class="stat-label">Ø¹Ø¯Ø¯ Ù…Ø´Ø§Ù‡Ø¯Ø§Øª Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ØªØ±ÙˆÙŠØ¬ ÙˆØ§Ù„Ù…Ø­ØªÙˆÙ‰</div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
(function() {
  const token = localStorage.getItem('token');
  if (!token) {
    window.location.href = './login.html';
    return;
  }

  const userData = JSON.parse(localStorage.getItem('user') || "{}");
  const projectId = userData.project ? userData.project : 3;

  const cachedReport = localStorage.getItem('projectReport');
  if (cachedReport) {
    console.log("âœ… Loaded data from cache");
    const data = JSON.parse(cachedReport);
    renderStats(data);
    localStorage.removeItem('projectReport');
  } else {
    console.log("ğŸ“¡ Fetching live data...");
    fetch(`https://api-stg.saaei.co/api/v1/projects/${projectId}/ownerProjectReport/get`, {
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    })
    .then(res => {
      if (!res.ok) throw new Error('ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
      return res.json();
    })
    .then(data => {
      renderStats(data);
    })
    .catch(err => {
      console.error('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', err);
    });
  }

  function renderStats(data) {
    document.getElementById('stat-value1').firstChild.textContent = data.contactCount ?? 0;
    document.getElementById('stat-value2').firstChild.textContent = data.visitingsCount ?? 0;
    document.getElementById('stat-value3').firstChild.textContent = data.bookingCount ?? 0;
    document.getElementById('stat-value4').firstChild.textContent = data.completedDeals ?? 0;
    document.getElementById('stat-value5').firstChild.textContent = data.unCompletedDeals ?? 0;
    document.getElementById('stat-value6').firstChild.textContent = data.totalViews ?? 0;

    if (data.project && data.project.name) {
      document.getElementById('projectName').textContent = data.project.name;
    }
    if (data.project && data.project.img) {
      document.getElementById('logo').src = data.project.img;
    }
  }
})();
</script>

</body>
</html>
